# Использование GPU

Поскольку распознавание лиц требует использования значительных вычислительных ресурсов, была добавлена возможность ускорения модулей Face SDK с использованием GPU для выполнения алгоритмов глубокого обучения. 

На данный момент GPU может быть использован для ускорения на следующих платформах: 

* Windows x86 64-bit 
* Linux x86 64-bit
* Android

В данном разделе представлена информация о том, для каких модулей Face SDK доступно ускорение, каким образом включить данную функцию, а также информация о скорости работы модулей с использованием CPU и GPU, возможные ошибки при использовании GPU и пути решения. 

## Desktop [beta]

На данный момент ускорение с использованием GPU доступно для следующих модулей Face SDK (доступно использование только одного GPU):

* распознаватели (recognizers) (9v30, 9v300, 9v1000, 9v30mask, 9v300mask, 9v1000mask) (см. [Идентификация лиц](face_identification.md))

* Требуемое ПО: 
   * Nvidia GPU Driver >= 410.48
   * [CUDA Toolkit 10.1](https://developer.nvidia.com/cuda-toolkit-archive)
   * [cuDNN 7](https://developer.nvidia.com/rdp/cudnn-archive#a-collapse765-90)
   * [Для Windows] [Microsoft Visual C++ Redistributable for Visual Studio 2019](https://visualstudio.microsoft.com/downloads/)
* Требования к оборудованию: 
   * графический процессор (GPU) с поддержкой CUDA (NVIDIA GTX 1050 Ti и выше)

Также есть возможность применять предсобранные docker-контейнеры с поддержкой CUDA, например,  *nvidia/cuda:10.0-cudnn7-devel-ubuntu16.04* (некоторые виды лицензий при этом могут быть недоступны).

Для запуска моделей на GPU требуется отредактировать конфигурационный файл поддерживаемого распознавателя, изменив поле `use_cuda` с `0` на `1`. Ускорение при этом происходит за счет одного из доступных GPU (по умолчанию – на GPU с индексом `0`). Индекс GPU можно изменить следующим образом:  
* через параметр конфигурационного файла `gpu_index`  
* через переменную окружения `CUDA_VISIBLE_DEVICES` (см. более подробную информацию о [переменных окружения CUDA](https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html#env-vars))

### Временные характеристики 

В таблице ниже представлены замеры скорости модулей Face SDK с использованием CPU и GPU: 

| Метод | GPU | CPU |
| ----- | --- | --- |
| 9v1000 | 13 мс | 730 мс | 
| 9v300 | 7 мс | 260 мс | 
| 9v30 | 3 мс | 30 мс | 

_**Примечание**: при проведении замеров скорости использовалась видеокарта NVIDIA GeForce GTX 1080 Ti и процессор Intel Core i7._ 

### Устранение неполадок 

| Ошибка  | Решение |
| ------- | ------- |
| `libtensorflow.so.2: cannot open shared object file: No such file or directory`  | Требуется задать переменную окружения `LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:/path/to/lib`, где `path/to/lib` – путь к директории *lib* из дистрибутива Face SDK, либо переместить этот файл по пути `../lib` относительно запускаемого приложения (т.к. в `libfacerec.so` задан `run-time search path`). |
| Медленная инициализация | Увеличьте размер JIT кэша: `export CUDA_CACHE_MAXSIZE=2147483647` (подробнее - [JIT Caching](https://developer.nvidia.com/blog/cuda-pro-tip-understand-fat-binaries-jit-caching/)) |

## Android [beta]

На данный момент ускорение с использованием GPU доступно для следующих модулей Face SDK:

* распознаватели (recognizers) (9v30, 9v300, 9v1000, 9v30mask, 9v300mask, 9v1000mask) (см. [Идентификация лиц](face_identification.md))
* детектор *blf* (см. [Детекция лиц](face_capturing.md))

Использование GPU можно включить/отключить через флаг `use_mobile_gpu` в конфигурационных файлах объектов `Capturer`, `Recognizer`, `VideoWorker` (в конфигурационном файле объекта `VideoWorker` использование GPU активируется для детекторов). По умолчанию поддержка мобильных GPU **включена** (значение `1`). Чтобы отключить использование GPU, измените значение флага `use_mobile_gpu` на `0`.

### Временные характеристики 

В таблице ниже представлены замеры скорости модулей Face SDK с использованием CPU и GPU: 

| Метод | CPU | GPU | 
| ----- | --- | --- |
| 9v1000 | 3660 мс | 610 мс | 
| 9v300 | 1960 мс | 280 мс |  
| 9v30 | 170 мс | 70 мс | 

_**Примечание**: при проведении замеров скорости использовалось устройство Google Pixel 3._
